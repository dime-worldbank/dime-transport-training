<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Session 3 - Spatial Data Operations</title>
    <meta charset="utf-8" />
    <meta name="author" content="Luiza Andrade, Rob Marty, Rony Rodriguez-Ramirez, Luis Eduardo San Martin, Leonardo Viotti" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/panelset/panelset.css" rel="stylesheet" />
    <script src="libs/panelset/panelset.js"></script>
    <script type="application/json" id="xaringanExtra-editable-docid">{"id":"xbe92e7ae024483fb2332be7f70c6026","expires":14}</script>
    <script src="libs/himalaya/himalaya.js"></script>
    <script src="libs/js-cookie/js.cookie.js"></script>
    <link href="libs/editable/editable.css" rel="stylesheet" />
    <script src="libs/editable/editable.js"></script>
    <script src="libs/clipboard/clipboard.min.js"></script>
    <link href="libs/xaringanExtra-clipboard/xaringanExtra-clipboard.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-clipboard/xaringanExtra-clipboard.js"></script>
    <script>window.xaringanExtraClipboard(null, {"button":"Copy Code","success":"Copied!","error":"Press Ctrl+C to Copy"})</script>
    <script>window.xaringanExtraClipboard(null, {"button":"<i class=\"fa fa-clipboard\"><\/i>","success":"<i class=\"fa fa-check\" style=\"color: #90BE6D\"><\/i>","error":"<i class=\"fa fa-times-circle\" style=\"color: #F94144\"><\/i>"})</script>
    <link href="libs/font-awesome/css/all.min.css" rel="stylesheet" />
    <link href="libs/font-awesome/css/v4-shims.min.css" rel="stylesheet" />
    <link href="libs/countdown/countdown.css" rel="stylesheet" />
    <script src="libs/countdown/countdown.js"></script>
    <link rel="stylesheet" href="libs/remark-css/default.css" type="text/css" />
    <link rel="stylesheet" href="libs/remark-css/metropolis.css" type="text/css" />
    <link rel="stylesheet" href="libs/remark-css/metropolis-fonts.css" type="text/css" />
    <link rel="stylesheet" href="libs/remark-css/custom.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Session 3 - Spatial Data Operations
]
.subtitle[
## <a href="https://github.com/worldbank">GIS for Transport</a>
]
.author[
### Luiza Andrade, Rob Marty, Rony Rodriguez-Ramirez, Luis Eduardo San Martin, Leonardo Viotti
]
.date[
### The World Bank – DIME | <a href="https://github.com/worldbank">WB Github</a> <br> April 2024
]

---




# Table of contents

.large[
1. Spatial operations applied on one dataset
2. Spatial operations applied on multiple datasets
]

---

# Setup

1. Copy/paste the following code into a new RStudio script, __replacing "YOURFOLDERPATHHERE" with the folder within which you'll place this R project__:

```r
library(usethis)
use_course(
  url = "https://github.com/dime-worldbank/dime-transport-training/archive/main.zip",
  destdir = "YOURFOLDERPATHHERE"
)
```

2\. In the console, type in the requisite number to delete the .zip file (we don't need it anymore).

3\. A new RStudio environment will open. Use this for the session today.

---

# Setup

Install new packages

```r
install.packages(c("sf",
                   "leaflet",
                   "geosphere"),
                 dependencies = TRUE)
```

---

# Setup

And load them

```r
library(here)
library(tidyverse)
library(sf)        # Simple features
library(leaflet)   # Interactive map
library(geosphere) # Great circle distances
```

---

# Load &amp; prep polygon of Nairobi


```r
country_sf &lt;- st_read(here("DataWork", 
                           "DataSets", 
                           "Final", 
                           "country.geojson"))
```

```
## Reading layer `country' from data source 
##   `/Users/robmarty/Documents/Github/gis-transport-training/DataWork/DataSets/Final/country.geojson' 
##   using driver `GeoJSON'
## Simple feature collection with 300 features and 13 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 33.90959 ymin: -4.720417 xmax: 41.92622 ymax: 5.061166
## Geodetic CRS:  WGS 84
```

```r
city_sf &lt;- country_sf %&gt;% 
  filter(NAME_1 == "Nairobi")
```

---

# Load and prep polyline of roads
Read in the roads dataset using `st_read` function from the `sf` package into R


```r
roads_sf &lt;- st_read(here("DataWork", 
                         "DataSets", 
                         "Final", 
                         "roads.geojson"))
```

```
## Reading layer `roads' from data source 
##   `/Users/robmarty/Documents/Github/gis-transport-training/DataWork/DataSets/Final/roads.geojson' 
##   using driver `GeoJSON'
## Simple feature collection with 3352 features and 3 fields
## Geometry type: MULTILINESTRING
## Dimension:     XY
## Bounding box:  xmin: 36.68034 ymin: -1.428946 xmax: 37.07664 ymax: -1.162558
## Geodetic CRS:  WGS 84
```

---

# Load and prep spatial points data of schools
Read in the schools data dataset using `read.csv` function from the `dplyr` package into R


```r
schools_df &lt;- read_csv(here("DataWork",
                "DataSets",
                "Final",
                "schools.csv"))
```

```
## Rows: 3549 Columns: 5
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: ","
## chr (2): name, amenity
## dbl (3): osm_id, longitude, latitude
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
```

---

# Load and prep spatial points data of schools
Convert the __schools_df__ into a spatial dataframe using the `st_as_sf`


```r
schools_sf &lt;- st_as_sf(schools_df, 
                       coords = c("longitude", "latitude"),
                       crs = 4326)
```
---

# Spatial operations applied on single dataset

* `st_transform`: Transform CRS
* `st_buffer`: Buffer point/line/polygon
* `st_combine`: Dissolve by attribute
* `st_centroid`: Create new sf object that uses the centroid
* `st_drop_geometry`: Drop geometry; convert from sf to dataframe
* `st_coordinates`: Get matrix of coordinates
* `st_bbox`: Get bounding box

---

# Transform CRS

The schools dataset is currently in a geographic CRS (WGS84), where the units are in decimal degrees. We'll tranform the CRS to a projected CRS ([EPSG:32632](https://epsg.io/32632)), and where the units will be in meters.

__Note that coordinate values are large!__ Values are large because units are in meters. Large coordinate values suggest projected CRS; latitude is between -90 and 90 and longitude is between -180 and 180.


```r
schools_utm_sf &lt;- st_transform(schools_sf, 32632)

schools_utm_sf$geometry %&gt;% head(2) %&gt;% print()
```

```
## Geometry set for 2 features 
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 3722217 ymin: -158522.3 xmax: 3723051 ymax: -157537.6
## Projected CRS: WGS 84 / UTM zone 32N
```

```
## POINT (3723051 -158522.3)
```

```
## POINT (3722217 -157537.6)
```

---

# Dissolve by an attribute

Below we have the second administrative regions. Using this dataset, let's create a new object at the first administrative region level. We are going to use `st_combine` function


```r
country_1_sf &lt;- country_sf %&gt;%
  group_by(NAME_1) %&gt;%
  summarise(geometry = st_combine(geometry)) %&gt;%
  ungroup()

ggplot() +
  geom_sf(data = country_1_sf)
```

&lt;img src="03-spatial-data-operations_files/figure-html/unnamed-chunk-9-1.png" width="30%" style="display: block; margin: auto;" /&gt;

---

# Buffer

We have the points of schools. Now we create a 1km buffer around schools.


```r
schools_1km_sf &lt;- schools_sf %&gt;%
  st_buffer(dist = 1000) # Units are in meters. Thanks s2!

ggplot() +
  geom_sf(data = schools_1km_sf)
```

&lt;img src="03-spatial-data-operations_files/figure-html/unnamed-chunk-10-1.png" width="50%" style="display: block; margin: auto;" /&gt;

---

# Exercise

.exercise[

**Exercise:** Filter the dataset to just trunk roads, and buffer the polyline by 10 meters. In `roads_sf`, the `highway` variable notes road types.

]

<div class="countdown" id="timer_e032743a" data-update-every="1" tabindex="0" style="bottom:0;left:0;font-size:2em;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">02</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

--

.solution[

**Solution**: 

```r
roads_sf %&gt;%
  filter(highway == "trunk") %&gt;%
  st_buffer(dist = 10)
```

```
## Simple feature collection with 336 features and 3 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 36.68362 ymin: -1.386311 xmax: 37.07676 ymax: -1.204877
## Geodetic CRS:  WGS 84
## First 10 features:
##     osm_id                        name highway                       geometry
## 1  4730073               Uhuru Highway   trunk MULTIPOLYGON (((36.81899 -1...
## 2  4730074               Uhuru Highway   trunk MULTIPOLYGON (((36.81922 -1...
## 3  4730089 Kenyatta Avenue Round About   trunk MULTIPOLYGON (((36.81754 -1...
## 4  4741915               Uhuru Highway   trunk MULTIPOLYGON (((36.81523 -1...
## 5  4741916               Uhuru Highway   trunk MULTIPOLYGON (((36.81493 -1...
## 6  4742005              University Way   trunk MULTIPOLYGON (((36.81527 -1...
## 7  4742013               Uhuru Highway   trunk MULTIPOLYGON (((36.81421 -1...
## 8  4742016                 Waiyaki Way   trunk MULTIPOLYGON (((36.80349 -1...
## 9  4751843                 Waiyaki Way   trunk MULTIPOLYGON (((36.80347 -1...
## 10 4751845        Westlands Roundabout   trunk MULTIPOLYGON (((36.80174 -1...
```

]

---

# Determine centroid

Sometimes we want to represent a polygon or polyline as a single point. For this, we can compute the centroid (ie, geographic center) of a polygon/polyline.

.center[
![Centroid](img/220px-Triangle.Centroid.svg.png)
]

__Source:__ [Wikipedia](https://en.wikipedia.org/wiki/Centroid)

---

# Determine centroid

Determine centroid of second administrative regions


```r
country_c_sf &lt;- st_centroid(country_sf)
```

```
## Warning: st_centroid assumes attributes are constant over geometries
```

```r
ggplot() +
  geom_sf(data = country_c_sf)
```

&lt;img src="03-spatial-data-operations_files/figure-html/unnamed-chunk-12-1.png" width="40%" style="display: block; margin: auto;" /&gt;

---

# Remove geometry

__Correct__


```r
city_sf %&gt;% 
  st_drop_geometry() %&gt;%
  head()
```

```
##        GID_2 GID_0 COUNTRY    GID_1  NAME_1 NL_NAME_1           NAME_2
## 1 KEN.30.1_1   KEN   Kenya KEN.30_1 Nairobi      &lt;NA&gt;  Dagoretti North
## 2 KEN.30.2_1   KEN   Kenya KEN.30_1 Nairobi      &lt;NA&gt;  Dagoretti South
## 3 KEN.30.3_1   KEN   Kenya KEN.30_1 Nairobi      &lt;NA&gt; Embakasi Central
## 4 KEN.30.4_1   KEN   Kenya KEN.30_1 Nairobi      &lt;NA&gt;    Embakasi East
## 5 KEN.30.5_1   KEN   Kenya KEN.30_1 Nairobi      &lt;NA&gt;   Embakasi North
## 6 KEN.30.6_1   KEN   Kenya KEN.30_1 Nairobi      &lt;NA&gt;   Embakasi South
##   VARNAME_2 NL_NAME_2       TYPE_2    ENGTYPE_2 CC_2 HASC_2
## 1      &lt;NA&gt;      &lt;NA&gt; Constituency Constituency  275   &lt;NA&gt;
## 2      &lt;NA&gt;      &lt;NA&gt; Constituency Constituency  276   &lt;NA&gt;
## 3      &lt;NA&gt;      &lt;NA&gt; Constituency Constituency  284   &lt;NA&gt;
## 4      &lt;NA&gt;      &lt;NA&gt; Constituency Constituency  285   &lt;NA&gt;
## 5      &lt;NA&gt;      &lt;NA&gt; Constituency Constituency  283   &lt;NA&gt;
## 6      &lt;NA&gt;      &lt;NA&gt; Constituency Constituency  282   &lt;NA&gt;
```

---

# Grab coordinates

Create a matrix of coordinates


```r
schools_sf %&gt;% 
  st_coordinates() %&gt;%
  head()
```

```
##             X         Y
## [1,] 36.80406 -1.267486
## [2,] 36.79734 -1.259690
## [3,] 36.77077 -1.290325
## [4,] 36.76877 -1.296051
## [5,] 36.79066 -1.258515
## [6,] 36.77899 -1.264575
```

---

# Get bounding box


```r
schools_sf %&gt;% 
  st_bbox() 
```

```
##      xmin      ymin      xmax      ymax 
## 36.691965 -1.374473 37.065336 -1.177316
```


# Spatial operations using multiple datasets

* `st_distance`: Calculate distances.
* `st_intersects`: Indicates whether simple features intersect.
* `st_intersection`: Cut one spatial object based on another.
* `st_difference`: Remove part of spatial object based on another.  
* `st_join`: Spatial join (ie, add attributes of one dataframe to another based on location). 
---

# Distances

For this example, we'll compute the distance between each school to a motorway.


```r
motor_sf &lt;- roads_sf %&gt;%
  filter(highway == "motorway")

# Matrix: distance of each school to each motorway
dist_mat &lt;- st_distance(schools_sf, motor_sf)

# Take minimun distance for each school
dist_mat %&gt;% apply(1, min) %&gt;% head()
```

```
## [1]   33.78464  155.32799 4006.16459 4662.68796  176.10524 1382.28513
```

---

# Distances

.exercise[

**Exercise:** What proportion of schools are within 1km of a trunk road?

]

--

.solution[
**Solution**: 

```r
## Trunk Road
trunk_sf &lt;- roads_sf %&gt;%
  filter(highway == "trunk")

# Matrix: distance of each school to each trunk road
dist_mat &lt;- st_distance(schools_sf, trunk_sf)

# Take minimun distance for each school
dist_to_trunk &lt;- dist_mat %&gt;% apply(1, min)

# Proportion within 1km
mean(dist_to_trunk &lt;= 1000)
```

```
## [1] 0.4725275
```

]

---

# Intersects

For this example we'll determine which second administrative divisions intersects with a motorway.


```r
# Sparse matrix
st_intersects(city_sf, motor_sf) %&gt;% print()
```

```
## Sparse geometry binary predicate list of length 17, where the predicate
## was `intersects'
## first 10 elements:
##  1: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, ...
##  2: (empty)
##  3: (empty)
##  4: 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, ...
##  5: (empty)
##  6: 30, 32, 33, 34, 35, 36, 37, 38, 39, 40, ...
##  7: (empty)
##  8: (empty)
##  9: (empty)
##  10: 42, 43, 45, 64
```

---

# Intersects

Take `max` (`FALSE` corresponds to 0 and `TRUE` corresponds to 1). So taking max will yeild if unit intersects with _any_ motorway


```r
# Matrix
st_intersects(city_sf, motor_sf, sparse = F) %&gt;% 
  apply(1, max) %&gt;%
  head()
```

```
## [1] 1 0 0 1 0 1
```

---

# Intersection

We have roads for the full city. Here, we want to create new roads object that __only includes__ roads in one unit.


```r
loc_sf &lt;- city_sf %&gt;%
  head(1)

roads_loc_sf &lt;- st_intersection(roads_sf, loc_sf)
```

```
## Warning: attribute variables are assumed to be spatially constant throughout
## all geometries
```

```r
ggplot() +
  geom_sf(data = roads_loc_sf)
```

&lt;img src="03-spatial-data-operations_files/figure-html/unnamed-chunk-20-1.png" width="40%" style="display: block; margin: auto;" /&gt;

---

# Difference

We have roads for all of the city. Here, we want to create new roads object that __excludes__ roads in one unit.


```r
roads_notloc_sf &lt;- st_difference(roads_sf, loc_sf)
```

```
## Warning: attribute variables are assumed to be spatially constant throughout
## all geometries
```

```r
ggplot() +
  geom_sf(data = loc_sf, fill = NA, color = "red") +
  geom_sf(data = roads_notloc_sf) 
```

&lt;img src="03-spatial-data-operations_files/figure-html/unnamed-chunk-21-1.png" width="40%" style="display: block; margin: auto;" /&gt;

---

# Overlay

Intersections and differencing are __overlay__ functions

.center[
![Overlay](img/overlay_examples.png)
]

---

# Spatial join

We have a dataset of schools. The school dataframe contains information such as the school name, but not on the administrative region it's in. To add data on the administrative region that the school is in, we'll perform a spatial join.

Check the variable names. No names of second administrative divison :(

```r
names(schools_sf)
```

```
## [1] "osm_id"   "name"     "amenity"  "geometry"
```

---

# Spatial join

Use `st_join` to add attributes from `city_sf` to `schools_sf`. `st_join` is similar to other join methods (eg, `left_join`); instead of joining on a varible, we join based on location.


```r
schools_city_sf &lt;- st_join(schools_sf, city_sf)

schools_city_sf %&gt;% 
  names() %&gt;% 
  print() %&gt;%
  tail(10)
```

```
##  [1] "osm_id"    "name"      "amenity"   "geometry"  "GID_2"     "GID_0"    
##  [7] "COUNTRY"   "GID_1"     "NAME_1"    "NL_NAME_1" "NAME_2"    "VARNAME_2"
## [13] "NL_NAME_2" "TYPE_2"    "ENGTYPE_2" "CC_2"      "HASC_2"
```

```
##  [1] "GID_1"     "NAME_1"    "NL_NAME_1" "NAME_2"    "VARNAME_2" "NL_NAME_2"
##  [7] "TYPE_2"    "ENGTYPE_2" "CC_2"      "HASC_2"
```

---

# Spatial join

Now, we create a dataset showing the number of schools within each administrative division.


```r
n_school_df &lt;- schools_city_sf %&gt;%
  st_drop_geometry() %&gt;%
  group_by(NAME_2) %&gt;%
  summarise(n_school = n()) %&gt;%
  ungroup()

head(n_school_df)
```

```
## # A tibble: 6 × 2
##   NAME_2           n_school
##   &lt;chr&gt;               &lt;int&gt;
## 1 Dagoretti North       355
## 2 Dagoretti South       193
## 3 Embakasi Central       13
## 4 Embakasi East         116
## 5 Embakasi North         79
## 6 Embakasi South        132
```

---

# Spatial join

.exercise[

**Exercise:** Make a static map using of administrative areas, where each administrative area polygon displays the number of schools. __Hint:__ (1) Use `left_join` to merge `city_sf` and `n_school_df`, (2) Use `ggplot` to make the map.

]

--

.solution[
**Solution**: 

```r
## Merge info with city_sf
city_sch_sf &lt;- city_sf %&gt;% left_join(n_school_df, by = "NAME_2")

## Map
p &lt;- ggplot() +
  geom_sf(data = city_sch_sf,
          aes(fill = n_school)) +
  labs(fill = "N\nSchools") +
  scale_fill_distiller(palette = "YlOrRd") +
  theme_void()
```
]

---

# Spatial join


```r
ggplot() +
  geom_sf(data = city_sch_sf,
          aes(fill = n_school)) +
  labs(fill = "N\nSchools") +
  scale_fill_distiller(palette = "YlOrRd") +
  theme_void()
```

&lt;img src="03-spatial-data-operations_files/figure-html/unnamed-chunk-26-1.png" width="65%" style="display: block; margin: auto;" /&gt;

---

# Resources

.large[
* [sf package cheatsheet](https://github.com/rstudio/cheatsheets/blob/main/sf.pdf)
* [Spatial Data Science with Applications in R](https://r-spatial.org/book/)
* [Geocomputation with R](https://r.geocompx.org/)
]

---

class: inverse, center, middle

# Thank you!

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
